<!-- ìœ„ìŠ¤í‚¤ ìƒì„¸ í˜ì´ì§€ -->
<main class="main-container">
    <div class="content-wrapper">
        <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
        <div class="page-header">
            <button onclick="history.back()" class="back-btn">
                <i class="fas fa-arrow-left"></i> ë’¤ë¡œê°€ê¸°
            </button>
            <h2 class="page-title">
                <i class="fas fa-glass-whiskey"></i> ìœ„ìŠ¤í‚¤ ìƒì„¸ì •ë³´
            </h2>
        </div>

        <div class="whiskey-detail-container">
            <!-- ìœ„ìŠ¤í‚¤ ê¸°ë³¸ ì •ë³´ -->
            <div class="whiskey-detail-card">
                <div class="whiskey-image-section">
                    <div class="whiskey-image-large">
                        <% if (whiskey.image_path) { %>
                            <img src="<%= whiskey.image_path %>" alt="<%= whiskey.name %>" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div class="whiskey-placeholder-large" style="display:none;">ğŸ¥ƒ</div>
                        <% } else { %>
                            <div class="whiskey-placeholder-large">ğŸ¥ƒ</div>
                        <% } %>
                    </div>
                </div>

                <div class="whiskey-info-section">
                    <h1 class="whiskey-title"><%= whiskey.name %></h1>
                    
                    <div class="whiskey-basic-info">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">
                                    <i class="fas fa-glass-whiskey"></i> íƒ€ì…
                                </span>
                                <span class="info-value"><%= whiskey.type || 'ë¯¸ìƒ' %></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">
                                    <i class="fas fa-globe"></i> ì›ì‚°ì§€
                                </span>
                                <span class="info-value"><%= whiskey.origin || 'ë¯¸ìƒ' %></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">
                                    <i class="fas fa-won-sign"></i> ê°€ê²©
                                </span>
                                <span class="info-value price"><%= whiskey.price.toLocaleString() %>ì›</span>
                            </div>
                            <% if (whiskey.age_years) { %>
                            <div class="info-item">
                                <span class="info-label">
                                    <i class="fas fa-hourglass-half"></i> ìˆ™ì„±ì—°ìˆ˜
                                </span>
                                <span class="info-value"><%= whiskey.age_years %>ë…„</span>
                            </div>
                            <% } %>
                            <% if (whiskey.alcohol) { %>
                            <div class="info-item">
                                <span class="info-label">
                                    <i class="fas fa-percentage"></i> ì•Œì½”ì˜¬ ë„ìˆ˜
                                </span>
                                <span class="info-value"><%= whiskey.alcohol %>%</span>
                            </div>
                            <% } %>
                        </div>
                    </div>

                    <!-- ë§› í”„ë¡œíŒŒì¼ -->
                    <div class="flavor-profile-section">
                        <h3><i class="fas fa-palette"></i> ë§› í”„ë¡œíŒŒì¼</h3>
                        <div class="flavor-profile-grid">
                            <div class="flavor-item">
                                <span class="flavor-label">ë°”ë””ê°</span>
                                <div class="flavor-bar">
                                    <div class="flavor-fill" style="width: <%= (whiskey.body || 0) * 20 %>%"></div>
                                </div>
                                <span class="flavor-value"><%= whiskey.body || 0 %>/5</span>
                            </div>
                            <div class="flavor-item">
                                <span class="flavor-label">í’ë¯¸</span>
                                <div class="flavor-bar">
                                    <div class="flavor-fill" style="width: <%= (whiskey.richness || 0) * 20 %>%"></div>
                                </div>
                                <span class="flavor-value"><%= whiskey.richness || 0 %>/5</span>
                            </div>
                            <div class="flavor-item">
                                <span class="flavor-label">ìŠ¤ëª¨í‚¤</span>
                                <div class="flavor-bar">
                                    <div class="flavor-fill" style="width: <%= (whiskey.smoke || 0) * 20 %>%"></div>
                                </div>
                                <span class="flavor-value"><%= whiskey.smoke || 0 %>/5</span>
                            </div>
                            <div class="flavor-item">
                                <span class="flavor-label">ë‹¨ë§›</span>
                                <div class="flavor-bar">
                                    <div class="flavor-fill" style="width: <%= (whiskey.sweetness || 0) * 20 %>%"></div>
                                </div>
                                <span class="flavor-value"><%= whiskey.sweetness || 0 %>/5</span>
                            </div>
                        </div>
                    </div>

                    <!-- ìƒì„¸ ì„¤ëª… -->
                    <% if (whiskey.description) { %>
                    <div class="description-section">
                        <h3><i class="fas fa-file-alt"></i> ì„¤ëª…</h3>
                        <p class="description-text"><%= whiskey.description %></p>
                    </div>
                    <% } %>

                    <!-- ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openReviewModal('<%= whiskey.whiskey_id %>')">
                            <i class="fas fa-star"></i> í‰ê°€í•˜ê¸°
                        </button>
                        <button class="btn btn-info" onclick="shareWhiskey('<%= whiskey.whiskey_id %>')">
                            <i class="fas fa-share"></i> ê³µìœ í•˜ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- í‰ê°€ ëª¨ë‹¬ (ê¸°ì¡´ ëª¨ë‹¬ ì¬ì‚¬ìš©) -->
<div id="whiskey-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">ìœ„ìŠ¤í‚¤ í‰ê°€</h3>
            <button id="close-modal-btn" class="close-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="modal-whiskey-info"></div>
            
            <div class="review-section">
                <h4><i class="fas fa-star"></i> í‰ê°€</h4>
                
                <div class="rating-grid">
                    <div class="rating-item">
                        <label>ì´ í‰ì </label>
                        <input type="range" id="overall-rating" min="0" max="5" value="3">
                        <span id="overall-rating-value">3</span>
                    </div>
                    <div class="rating-item">
                        <label>ë°”ë””ê°</label>
                        <input type="range" id="body-rating" min="0" max="5" value="3">
                        <span id="body-rating-value">3</span>
                    </div>
                    <div class="rating-item">
                        <label>í’ë¯¸</label>
                        <input type="range" id="richness-rating" min="0" max="5" value="3">
                        <span id="richness-rating-value">3</span>
                    </div>
                    <div class="rating-item">
                        <label>ìŠ¤ëª¨í‚¤í•¨</label>
                        <input type="range" id="smokiness-rating" min="0" max="5" value="3">
                        <span id="smokiness-rating-value">3</span>
                    </div>
                    <div class="rating-item">
                        <label>ë‹¨ë§›</label>
                        <input type="range" id="sweetness-rating" min="0" max="5" value="3">
                        <span id="sweetness-rating-value">3</span>
                    </div>
                </div>
                
                <div class="review-text-section">
                    <label for="review-text">ë¦¬ë·° ì‘ì„±</label>
                    <textarea id="review-text" placeholder="ì´ ìœ„ìŠ¤í‚¤ì— ëŒ€í•œ ë‹¹ì‹ ì˜ ìƒê°ì„ ë“¤ë ¤ì£¼ì„¸ìš”..."></textarea>
                </div>
                
                <button id="submit-review-btn" class="btn btn-primary">
                    <i class="fas fa-check"></i> í‰ê°€ ì €ì¥
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ì‚¬ìš©ì ë¦¬ë·° ì„¹ì…˜ -->
<div class="user-reviews-section">
    <div class="reviews-header">
        <h3 class="reviews-title">
            <i class="fas fa-comments"></i> ì‚¬ìš©ì ë¦¬ë·° (<%= reviewCount %>ê°œ)
        </h3>
        <% if (reviewCount > 0) { %>
            <div class="average-rating">
                <i class="fas fa-star"></i>
                <span class="rating-value"><%= averageRating %></span>
                <span class="rating-label">í‰ê·  í‰ì </span>
            </div>
        <% } %>
    </div>

    <div class="reviews-container">
        <% if (reviewCount === 0) { %>
            <div class="no-reviews">
                <i class="fas fa-comment-slash"></i>
                <p>ì•„ì§ ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <p>ì²« ë²ˆì§¸ ë¦¬ë·°ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!</p>
            </div>
        <% } else { %>
            <% reviews.forEach(review => { %>
                <div class="review-card">
                    <div class="review-header">
                        <div class="reviewer-info">
                            <i class="fas fa-user-circle"></i>
                            <span class="reviewer-name"><%= review.userInfo.username %></span>
                        </div>
                        <div class="review-meta">
                            <div class="review-rating">
                                <i class="fas fa-star"></i>
                                <span><%= review.rating %></span>
                            </div>
                            <div class="review-date">
                                <%= new Date(review.write_date).toLocaleDateString('ko-KR') %>
                            </div>
                        </div>
                    </div>
                    
                    <div class="review-content">
                        <% if (review.review_text && typeof review.review_text === 'string' && review.review_text.trim()) { %>
                            <p class="review-text"><%= review.review_text %></p>
                        <% } %>
                        
                        <div class="review-details">
                            <div class="detail-item">
                                <span class="detail-label">ë°”ë””ê°</span>
                                <div class="detail-rating">
                                    <% for (let i = 1; i <= 5; i++) { %>
                                        <i class="fas fa-circle <%= i <= (review.body || 0) ? 'active' : '' %>"></i>
                                    <% } %>
                                </div>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">í’ë¯¸</span>
                                <div class="detail-rating">
                                    <% for (let i = 1; i <= 5; i++) { %>
                                        <i class="fas fa-circle <%= i <= review.richness ? 'active' : '' %>"></i>
                                    <% } %>
                                </div>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ìŠ¤ëª¨í‚¤í•¨</span>
                                <div class="detail-rating">
                                    <% for (let i = 1; i <= 5; i++) { %>
                                        <i class="fas fa-circle <%= i <= review.smoke ? 'active' : '' %>"></i>
                                    <% } %>
                                </div>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ë‹¨ë§›</span>
                                <div class="detail-rating">
                                    <% for (let i = 1; i <= 5; i++) { %>
                                        <i class="fas fa-circle <%= i <= review.sweetness ? 'active' : '' %>"></i>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <% }); %>
        <% } %>
    </div>
</div>

<script>
// í‰ê°€ ëª¨ë‹¬ ì—´ê¸°
async function openReviewModal(whiskeyId) {
    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ì„ ìœ„í•´ ê¸°ì¡´ ë¦¬ë·° ì¡°íšŒ API í˜¸ì¶œ
    try {
        const checkResponse = await fetch(`/api/review/${whiskeyId}`);
        if (checkResponse.status === 401) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
            return;
        }
    } catch (error) {
        // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“±ì˜ ê²½ìš°ì—ë„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = '/login';
        return;
    }
    
    const modal = document.getElementById('whiskey-modal');
    const title = document.getElementById('modal-title');
    
    title.textContent = '<%= whiskey.name %> í‰ê°€';
    modal.classList.remove('hidden');
    modal.dataset.whiskeyId = whiskeyId;
    
    // ê¸°ì¡´ ë¦¬ë·°ê°€ ìˆëŠ”ì§€ í™•ì¸ (ì´ë¯¸ ìœ„ì—ì„œ ë¡œê·¸ì¸ ì²´í¬ë¥¼ ìœ„í•´ í˜¸ì¶œí–ˆìœ¼ë¯€ë¡œ ë‹¤ì‹œ í˜¸ì¶œ)
    try {
        const response = await fetch(`/api/review/${whiskeyId}`);
        if (response.ok) {
            const review = await response.json();
            // ê¸°ì¡´ ë¦¬ë·° ë°ì´í„°ë¡œ í¼ ì±„ìš°ê¸°
            document.getElementById('overall-rating').value = review.rating;
            document.getElementById('overall-rating-value').textContent = review.rating;
            document.getElementById('body-rating').value = review.body || 3;
            document.getElementById('body-rating-value').textContent = review.body || 3;
            document.getElementById('richness-rating').value = review.richness || 3;
            document.getElementById('richness-rating-value').textContent = review.richness || 3;
            document.getElementById('smokiness-rating').value = review.smoke || 3;
            document.getElementById('smokiness-rating-value').textContent = review.smoke || 3;
            document.getElementById('sweetness-rating').value = review.sweetness || 3;
            document.getElementById('sweetness-rating-value').textContent = review.sweetness || 3;
            document.getElementById('review-text').value = review.review_text || '';
        } else if (response.status === 404) {
            // ê¸°ì¡´ ë¦¬ë·°ê°€ ì—†ëŠ” ê²½ìš° - ê¸°ë³¸ê°’ ìœ ì§€
            console.log('ê¸°ì¡´ ë¦¬ë·° ì—†ìŒ');
        }
    } catch (error) {
        console.log('ê¸°ì¡´ ë¦¬ë·° ë¡œë”© ì‹¤íŒ¨:', error);
    }
}

// ê³µìœ í•˜ê¸°
function shareWhiskey(whiskeyId) {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
        alert('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }).catch(() => {
        alert('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}

// ë¦¬ë·° ì œì¶œ
async function submitReview() {
    const modal = document.getElementById('whiskey-modal');
    const whiskeyId = modal.dataset.whiskeyId;
    
    const reviewData = {
        whiskey_id: whiskeyId,
        rating: parseInt(document.getElementById('overall-rating').value),
        body: parseInt(document.getElementById('body-rating').value),
        richness: parseInt(document.getElementById('richness-rating').value),
        smoke: parseInt(document.getElementById('smokiness-rating').value),
        sweetness: parseInt(document.getElementById('sweetness-rating').value),
        review_text: document.getElementById('review-text').value.trim()
    };
    
    try {
        const response = await fetch('/api/review', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(reviewData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            modal.classList.add('hidden');
            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì—…ë°ì´íŠ¸ëœ ì •ë³´ í‘œì‹œ
            location.reload();
        } else {
            alert('ë¦¬ë·° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.error);
        }
    } catch (error) {
        console.error('ë¦¬ë·° ì €ì¥ ì˜¤ë¥˜:', error);
        alert('ë¦¬ë·° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ëª¨ë‹¬ ë‹«ê¸°
document.getElementById('close-modal-btn').addEventListener('click', () => {
    document.getElementById('whiskey-modal').classList.add('hidden');
});

// ë¦¬ë·° ì œì¶œ ë²„íŠ¼ ì´ë²¤íŠ¸
document.getElementById('submit-review-btn').addEventListener('click', submitReview);

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.getElementById('whiskey-modal').addEventListener('click', (e) => {
    if (e.target.id === 'whiskey-modal') {
        document.getElementById('whiskey-modal').classList.add('hidden');
    }
});

// ë²”ìœ„ ìŠ¬ë¼ì´ë” ê°’ ì—…ë°ì´íŠ¸
document.querySelectorAll('input[type="range"]').forEach(input => {
    input.addEventListener('input', (e) => {
        const valueSpan = document.getElementById(e.target.id + '-value');
        if (valueSpan) {
            valueSpan.textContent = e.target.value;
        }
    });
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ìµœê·¼ ë³¸ ìœ„ìŠ¤í‚¤ì— ì¶”ê°€
async function addToRecentView() {
    const whiskeyId = '<%= whiskey.whiskey_id %>';
    
    try {
        await fetch('/api/recent-view', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ whiskey_id: whiskeyId })
        });
    } catch (error) {
        console.log('ìµœê·¼ ë³¸ ìœ„ìŠ¤í‚¤ ì¶”ê°€ ì‹¤íŒ¨:', error);
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
document.addEventListener('DOMContentLoaded', addToRecentView);
</script>
