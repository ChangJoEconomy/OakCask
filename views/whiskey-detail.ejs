<!-- ÏúÑÏä§ÌÇ§ ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄ -->
<main class="main-container">
    <div class="content-wrapper">
        <!-- Îí§Î°úÍ∞ÄÍ∏∞ Î≤ÑÌäº -->
        <div class="page-header">
            <button onclick="history.back()" class="back-btn">
                <i class="fas fa-arrow-left"></i> Îí§Î°úÍ∞ÄÍ∏∞
            </button>
            <h2 class="page-title">
                <i class="fas fa-glass-whiskey"></i> ÏúÑÏä§ÌÇ§ ÏÉÅÏÑ∏Ï†ïÎ≥¥
            </h2>
        </div>

        <div class="whiskey-detail-container">
            <!-- ÏúÑÏä§ÌÇ§ Í∏∞Î≥∏ Ï†ïÎ≥¥ -->
            <div class="whiskey-detail-card">
                <div class="whiskey-image-section">
                    <div class="whiskey-image-large">
                        <% if (whiskey.image_path) { %>
                            <img src="<%= whiskey.image_path %>" alt="<%= whiskey.name %>" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div class="whiskey-placeholder-large" style="display:none;">ü•É</div>
                        <% } else { %>
                            <div class="whiskey-placeholder-large">ü•É</div>
                        <% } %>
                    </div>
                </div>

                <div class="whiskey-info-section">
                    <h1 class="whiskey-title"><%= whiskey.name %></h1>
                    
                    <div class="whiskey-basic-info">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">
                                    <i class="fas fa-glass-whiskey"></i> ÌÉÄÏûÖ
                                </span>
                                <span class="info-value"><%= whiskey.type || 'ÎØ∏ÏÉÅ' %></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">
                                    <i class="fas fa-globe"></i> ÏõêÏÇ∞ÏßÄ
                                </span>
                                <span class="info-value"><%= whiskey.origin || 'ÎØ∏ÏÉÅ' %></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">
                                    <i class="fas fa-won-sign"></i> Í∞ÄÍ≤©
                                </span>
                                <span class="info-value price"><%= whiskey.price.toLocaleString() %>Ïõê</span>
                            </div>
                            <% if (whiskey.age_years) { %>
                            <div class="info-item">
                                <span class="info-label">
                                    <i class="fas fa-hourglass-half"></i> ÏàôÏÑ±Ïó∞Ïàò
                                </span>
                                <span class="info-value"><%= whiskey.age_years %>ÎÖÑ</span>
                            </div>
                            <% } %>
                            <% if (whiskey.alcohol) { %>
                            <div class="info-item">
                                <span class="info-label">
                                    <i class="fas fa-percentage"></i> ÏïåÏΩîÏò¨ ÎèÑÏàò
                                </span>
                                <span class="info-value"><%= whiskey.alcohol %>%</span>
                            </div>
                            <% } %>
                        </div>
                    </div>

                    <!-- Îßõ ÌîÑÎ°úÌååÏùº -->
                    <div class="flavor-profile-section">
                        <h3><i class="fas fa-palette"></i> Îßõ ÌîÑÎ°úÌååÏùº</h3>
                        <div class="flavor-profile-grid">
                            <div class="flavor-item">
                                <span class="flavor-label">Î∞îÎîîÍ∞ê</span>
                                <div class="flavor-bar">
                                    <div class="flavor-fill" style="width: <%= (whiskey.body || 0) * 20 %>%"></div>
                                </div>
                                <span class="flavor-value"><%= whiskey.body || 0 %>/5</span>
                            </div>
                            <div class="flavor-item">
                                <span class="flavor-label">ÌíçÎØ∏</span>
                                <div class="flavor-bar">
                                    <div class="flavor-fill" style="width: <%= (whiskey.richness || 0) * 20 %>%"></div>
                                </div>
                                <span class="flavor-value"><%= whiskey.richness || 0 %>/5</span>
                            </div>
                            <div class="flavor-item">
                                <span class="flavor-label">Ïä§Î™®ÌÇ§</span>
                                <div class="flavor-bar">
                                    <div class="flavor-fill" style="width: <%= (whiskey.smoke || 0) * 20 %>%"></div>
                                </div>
                                <span class="flavor-value"><%= whiskey.smoke || 0 %>/5</span>
                            </div>
                            <div class="flavor-item">
                                <span class="flavor-label">Îã®Îßõ</span>
                                <div class="flavor-bar">
                                    <div class="flavor-fill" style="width: <%= (whiskey.sweetness || 0) * 20 %>%"></div>
                                </div>
                                <span class="flavor-value"><%= whiskey.sweetness || 0 %>/5</span>
                            </div>
                        </div>
                    </div>

                    <!-- ÏÉÅÏÑ∏ ÏÑ§Î™Ö -->
                    <% if (whiskey.description) { %>
                    <div class="description-section">
                        <h3><i class="fas fa-file-alt"></i> ÏÑ§Î™Ö</h3>
                        <p class="description-text"><%= whiskey.description %></p>
                    </div>
                    <% } %>

                    <!-- Ïï°ÏÖò Î≤ÑÌäºÎì§ -->
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openReviewModal('<%= whiskey.whiskey_id %>')">
                            <i class="fas fa-star"></i> ÌèâÍ∞ÄÌïòÍ∏∞
                        </button>
                        <button class="btn btn-info" onclick="shareWhiskey('<%= whiskey.whiskey_id %>')">
                            <i class="fas fa-share"></i> Í≥µÏú†ÌïòÍ∏∞
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- ÌèâÍ∞Ä Î™®Îã¨ (Í∏∞Ï°¥ Î™®Îã¨ Ïû¨ÏÇ¨Ïö©) -->
<div id="whiskey-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">ÏúÑÏä§ÌÇ§ ÌèâÍ∞Ä</h3>
            <button id="close-modal-btn" class="close-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="modal-whiskey-info"></div>
            
            <div class="review-section">
                <h4><i class="fas fa-star"></i> ÌèâÍ∞Ä</h4>
                
                <div class="rating-grid">
                    <div class="rating-item">
                        <label>Ï¥ù ÌèâÏ†ê</label>
                        <input type="range" id="overall-rating" min="0" max="5" value="3">
                        <span id="overall-rating-value">3</span>
                    </div>
                    <div class="rating-item">
                        <label>Î∞îÎîîÍ∞ê</label>
                        <input type="range" id="body-rating" min="0" max="5" value="3">
                        <span id="body-rating-value">3</span>
                    </div>
                    <div class="rating-item">
                        <label>ÌíçÎØ∏</label>
                        <input type="range" id="richness-rating" min="0" max="5" value="3">
                        <span id="richness-rating-value">3</span>
                    </div>
                    <div class="rating-item">
                        <label>Ïä§Î™®ÌÇ§Ìï®</label>
                        <input type="range" id="smokiness-rating" min="0" max="5" value="3">
                        <span id="smokiness-rating-value">3</span>
                    </div>
                    <div class="rating-item">
                        <label>Îã®Îßõ</label>
                        <input type="range" id="sweetness-rating" min="0" max="5" value="3">
                        <span id="sweetness-rating-value">3</span>
                    </div>
                </div>
                
                <div class="review-text-section">
                    <label for="review-text">Î¶¨Î∑∞ ÏûëÏÑ±</label>
                    <textarea id="review-text" placeholder="Ïù¥ ÏúÑÏä§ÌÇ§Ïóê ÎåÄÌïú ÎãπÏã†Ïùò ÏÉùÍ∞ÅÏùÑ Îì§Î†§Ï£ºÏÑ∏Ïöî..."></textarea>
                </div>
                
                <button id="submit-review-btn" class="btn btn-primary">
                    <i class="fas fa-check"></i> ÌèâÍ∞Ä Ï†ÄÏû•
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ÏÇ¨Ïö©Ïûê Î¶¨Î∑∞ ÏÑπÏÖò -->
<div class="user-reviews-section">
    <div class="reviews-header">
        <h3 class="reviews-title">
            <i class="fas fa-comments"></i> ÏÇ¨Ïö©Ïûê Î¶¨Î∑∞ (<%= reviewCount %>Í∞ú)
        </h3>
        <% if (reviewCount > 0) { %>
            <div class="average-rating">
                <i class="fas fa-star"></i>
                <span class="rating-value"><%= averageRating %></span>
                <span class="rating-label">ÌèâÍ∑† ÌèâÏ†ê</span>
            </div>
        <% } %>
    </div>

    <div class="reviews-container">
        <% if (reviewCount === 0) { %>
            <div class="no-reviews">
                <i class="fas fa-comment-slash"></i>
                <p>ÏïÑÏßÅ ÏûëÏÑ±Îêú Î¶¨Î∑∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                <p>Ï≤´ Î≤àÏß∏ Î¶¨Î∑∞Î•º ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî!</p>
            </div>
        <% } else { %>
            <% reviews.forEach(review => { %>
                <div class="review-card">
                    <div class="review-header">
                        <div class="reviewer-info">
                            <i class="fas fa-user-circle"></i>
                            <span class="reviewer-name"><%= review.userInfo.username %></span>
                        </div>
                        <div class="review-meta">
                            <div class="review-rating">
                                <i class="fas fa-star"></i>
                                <span><%= review.rating %></span>
                            </div>
                            <div class="review-date">
                                <%= new Date(review.write_date).toLocaleDateString('ko-KR') %>
                            </div>
                        </div>
                    </div>
                    
                    <div class="review-content">
                        <% if (review.review_text && typeof review.review_text === 'string' && review.review_text.trim()) { %>
                            <p class="review-text"><%= review.review_text %></p>
                        <% } %>
                        
                        <div class="review-details">
                            <div class="detail-item">
                                <span class="detail-label">Î∞îÎîîÍ∞ê</span>
                                <div class="detail-rating">
                                    <% for (let i = 1; i <= 5; i++) { %>
                                        <i class="fas fa-circle <%= i <= (review.body || 0) ? 'active' : '' %>"></i>
                                    <% } %>
                                </div>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ÌíçÎØ∏</span>
                                <div class="detail-rating">
                                    <% for (let i = 1; i <= 5; i++) { %>
                                        <i class="fas fa-circle <%= i <= review.richness ? 'active' : '' %>"></i>
                                    <% } %>
                                </div>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Ïä§Î™®ÌÇ§Ìï®</span>
                                <div class="detail-rating">
                                    <% for (let i = 1; i <= 5; i++) { %>
                                        <i class="fas fa-circle <%= i <= review.smoke ? 'active' : '' %>"></i>
                                    <% } %>
                                </div>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Îã®Îßõ</span>
                                <div class="detail-rating">
                                    <% for (let i = 1; i <= 5; i++) { %>
                                        <i class="fas fa-circle <%= i <= review.sweetness ? 'active' : '' %>"></i>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            <% }); %>
        <% } %>
    </div>
</div>

<script>
// ÌèâÍ∞Ä Î™®Îã¨ Ïó¥Í∏∞
async function openReviewModal(whiskeyId) {
    // Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú ÌôïÏù∏ÏùÑ ÏúÑÌï¥ Í∏∞Ï°¥ Î¶¨Î∑∞ Ï°∞Ìöå API Ìò∏Ï∂ú
    try {
        const checkResponse = await fetch(`/api/review/${whiskeyId}`);
        if (checkResponse.status === 401) {
            alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
            window.location.href = '/login';
            return;
        }
    } catch (error) {
        // ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò Îì±Ïùò Í≤ΩÏö∞ÏóêÎèÑ Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
        alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
        window.location.href = '/login';
        return;
    }
    
    const modal = document.getElementById('whiskey-modal');
    const title = document.getElementById('modal-title');
    
    title.textContent = '<%= whiskey.name %> ÌèâÍ∞Ä';
    modal.classList.remove('hidden');
    modal.dataset.whiskeyId = whiskeyId;
    
    // Í∏∞Ï°¥ Î¶¨Î∑∞Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏ (Ïù¥ÎØ∏ ÏúÑÏóêÏÑú Î°úÍ∑∏Ïù∏ Ï≤¥ÌÅ¨Î•º ÏúÑÌï¥ Ìò∏Ï∂úÌñàÏúºÎØÄÎ°ú Îã§Ïãú Ìò∏Ï∂ú)
    try {
        const response = await fetch(`/api/review/${whiskeyId}`);
        if (response.ok) {
            const review = await response.json();
            // Í∏∞Ï°¥ Î¶¨Î∑∞ Îç∞Ïù¥ÌÑ∞Î°ú Ìèº Ï±ÑÏö∞Í∏∞
            document.getElementById('overall-rating').value = review.rating;
            document.getElementById('overall-rating-value').textContent = review.rating;
            document.getElementById('body-rating').value = review.body || 3;
            document.getElementById('body-rating-value').textContent = review.body || 3;
            document.getElementById('richness-rating').value = review.richness || 3;
            document.getElementById('richness-rating-value').textContent = review.richness || 3;
            document.getElementById('smokiness-rating').value = review.smoke || 3;
            document.getElementById('smokiness-rating-value').textContent = review.smoke || 3;
            document.getElementById('sweetness-rating').value = review.sweetness || 3;
            document.getElementById('sweetness-rating-value').textContent = review.sweetness || 3;
            document.getElementById('review-text').value = review.review_text || '';
        } else if (response.status === 404) {
            // Í∏∞Ï°¥ Î¶¨Î∑∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ - Í∏∞Î≥∏Í∞í Ïú†ÏßÄ
            console.log('Í∏∞Ï°¥ Î¶¨Î∑∞ ÏóÜÏùå');
        }
    } catch (error) {
        console.log('Í∏∞Ï°¥ Î¶¨Î∑∞ Î°úÎî© Ïã§Ìå®:', error);
    }
}

// Í≥µÏú†ÌïòÍ∏∞
function shareWhiskey(whiskeyId) {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
        alert('ÎßÅÌÅ¨Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!');
    }).catch(() => {
        alert('ÎßÅÌÅ¨ Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    });
}

// Î¶¨Î∑∞ Ï†úÏ∂ú
async function submitReview() {
    const modal = document.getElementById('whiskey-modal');
    const whiskeyId = modal.dataset.whiskeyId;
    
    const reviewData = {
        whiskey_id: whiskeyId,
        rating: parseInt(document.getElementById('overall-rating').value),
        body: parseInt(document.getElementById('body-rating').value),
        richness: parseInt(document.getElementById('richness-rating').value),
        smoke: parseInt(document.getElementById('smokiness-rating').value),
        sweetness: parseInt(document.getElementById('sweetness-rating').value),
        review_text: document.getElementById('review-text').value.trim()
    };
    
    try {
        const response = await fetch('/api/review', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(reviewData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            modal.classList.add('hidden');
            // ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏó¨ ÏóÖÎç∞Ïù¥Ìä∏Îêú Ï†ïÎ≥¥ ÌëúÏãú
            location.reload();
        } else {
            alert('Î¶¨Î∑∞ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + result.error);
        }
    } catch (error) {
        console.error('Î¶¨Î∑∞ Ï†ÄÏû• Ïò§Î•ò:', error);
        alert('Î¶¨Î∑∞ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    }
}

// Î™®Îã¨ Îã´Í∏∞
document.getElementById('close-modal-btn').addEventListener('click', () => {
    document.getElementById('whiskey-modal').classList.add('hidden');
});

// Î¶¨Î∑∞ Ï†úÏ∂ú Î≤ÑÌäº Ïù¥Î≤§Ìä∏
document.getElementById('submit-review-btn').addEventListener('click', submitReview);

// Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
document.getElementById('whiskey-modal').addEventListener('click', (e) => {
    if (e.target.id === 'whiskey-modal') {
        document.getElementById('whiskey-modal').classList.add('hidden');
    }
});

// Î≤îÏúÑ Ïä¨ÎùºÏù¥Îçî Í∞í ÏóÖÎç∞Ïù¥Ìä∏
document.querySelectorAll('input[type="range"]').forEach(input => {
    input.addEventListener('input', (e) => {
        const valueSpan = document.getElementById(e.target.id + '-value');
        if (valueSpan) {
            valueSpan.textContent = e.target.value;
        }
    });
});

// ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏµúÍ∑º Î≥∏ ÏúÑÏä§ÌÇ§Ïóê Ï∂îÍ∞Ä
async function addToRecentView() {
    const whiskeyId = '<%= whiskey.whiskey_id %>';
    
    try {
        await fetch('/api/recent-view', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ whiskey_id: whiskeyId })
        });
    } catch (error) {
        console.log('ÏµúÍ∑º Î≥∏ ÏúÑÏä§ÌÇ§ Ï∂îÍ∞Ä Ïã§Ìå®:', error);
    }
}

// ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïã§Ìñâ
document.addEventListener('DOMContentLoaded', addToRecentView);
</script>
