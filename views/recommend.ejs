<!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
<main class="main-container">
    <div class="content-wrapper">
        <div class="page-header">
            <h2 class="page-title">
                <i class="fas fa-robot"></i> AI ìœ„ìŠ¤í‚¤ ì¶”ì²œë°›ê¸°
            </h2>
            <p class="page-subtitle">ê°œì¸í™”ëœ AI ì¶”ì²œìœ¼ë¡œ ì™„ë²½í•œ ìœ„ìŠ¤í‚¤ë¥¼ ì°¾ì•„ë³´ì„¸ìš”</p>
        </div>

        <div class="content-card">
            <div class="input-section">
                <!-- ì·¨í–¥ì •ë³´ ë°˜ì˜ í† ê¸€ -->
                <div class="preference-toggle-section">
                    <div class="toggle-wrapper">
                        <label class="toggle-container">
                            <input type="checkbox" id="use-preferences" class="toggle-input">
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="toggle-info">
                            <h4 class="toggle-title">
                                <i class="fas fa-user-cog"></i> ë‚´ ì·¨í–¥ì •ë³´ ë°˜ì˜í•˜ê¸°
                            </h4>
                            <p class="toggle-description">
                                ì €ì¥ëœ ì·¨í–¥ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë” ê°œì¸í™”ëœ ì¶”ì²œì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                            <div id="preference-status" class="preference-status"></div>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label for="user-query" class="input-label">
                        <i class="fas fa-comment-dots"></i> ì–´ë–¤ ìœ„ìŠ¤í‚¤ë¥¼ ì°¾ê³  ê³„ì‹ ê°€ìš”?
                    </label>
                    <textarea 
                        id="user-query" 
                        class="query-input" 
                        placeholder="ì˜ˆì‹œ:
â€¢ 'ë¶€ë“œëŸ½ê³  ë‹¬ì½¤í•œ ìœ„ìŠ¤í‚¤ ì¶”ì²œí•´ì¤˜'
â€¢ 'í”¼íŠ¸í–¥ ê°•í•œ ì‹±ê¸€ëª°íŠ¸ 10ë§Œì› ì´í•˜ë¡œ ì°¾ì•„ì¤˜'
â€¢ 'ì´ˆë³´ìì—ê²Œ ì¢‹ì€ ì…ë¬¸ìš© ìœ„ìŠ¤í‚¤ëŠ”?'
â€¢ 'ì„ ë¬¼ìš©ìœ¼ë¡œ ì¢‹ì€ í”„ë¦¬ë¯¸ì—„ ìœ„ìŠ¤í‚¤ ì¶”ì²œ'"
                        rows="5"></textarea>
                </div>
                <button id="recommend-btn" class="primary-btn">
                    <i class="fas fa-search"></i> ìœ„ìŠ¤í‚¤ ì¶”ì²œë°›ê¸°
                </button>
            </div>
            
            <div id="recommendations-container" class="recommendations-container hidden">
                <div class="recommendations-header">
                    <h3 class="recommendations-title">
                        <i class="fas fa-sparkles"></i> ì¶”ì²œ ìœ„ìŠ¤í‚¤
                    </h3>
                    <div class="recommendation-count">
                        <span id="recommendation-count-text">0ê°œì˜ ì¶”ì²œ ê²°ê³¼</span>
                    </div>
                </div>
                <div id="recommendations-grid" class="whiskey-grid"></div>
                <div class="feedback-notice">
                    <i class="fas fa-lightbulb"></i>
                    <p>ì¶”ì²œ ê²°ê³¼ì— ëŒ€í•œ í”¼ë“œë°±ì„ ì£¼ì‹œë©´ ë” ì •í™•í•œ ì¶”ì²œì„ ì œê³µí•´ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </div>
</main>
<!-- ìœ„ìŠ¤í‚¤ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
<div id="whiskey-modal" class="whiskey-modal hidden">
    <div class="modal-backdrop" onclick="closeWhiskeyModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-whiskey-name">ìœ„ìŠ¤í‚¤ ì´ë¦„</h3>
            <button class="modal-close-btn" onclick="closeWhiskeyModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <div class="whiskey-main-info">
                <div class="whiskey-image-large">
                    <div class="whiskey-icon">ğŸ¥ƒ</div>
                </div>
                
                <div class="whiskey-details">
                    <div class="detail-item">
                        <span class="detail-label">ê°€ê²©</span>
                        <span id="modal-price" class="detail-value">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">ìˆ™ì„± ì—°ìˆ˜</span>
                        <span id="modal-age" class="detail-value">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">ì›ì‚°ì§€</span>
                        <span id="modal-origin" class="detail-value">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">íƒ€ì…</span>
                        <span id="modal-type" class="detail-value">-</span>
                    </div>
                </div>
            </div>
            
            <div class="flavor-profile-section">
                <h4>ë§› í”„ë¡œí•„</h4>
                <div class="flavor-bars">
                    <div class="flavor-bar">
                        <span class="flavor-name">ë°”ë””ê°</span>
                        <div class="bar-container">
                            <div id="modal-body-bar" class="bar-fill"></div>
                        </div>
                        <span id="modal-body-score" class="flavor-score">0</span>
                    </div>
                    <div class="flavor-bar">
                        <span class="flavor-name">í’ë¶€í•¨</span>
                        <div class="bar-container">
                            <div id="modal-richness-bar" class="bar-fill"></div>
                        </div>
                        <span id="modal-richness-score" class="flavor-score">0</span>
                    </div>
                    <div class="flavor-bar">
                        <span class="flavor-name">ìŠ¤ëª¨í‚¤</span>
                        <div class="bar-container">
                            <div id="modal-smoke-bar" class="bar-fill"></div>
                        </div>
                        <span id="modal-smoke-score" class="flavor-score">0</span>
                    </div>
                    <div class="flavor-bar">
                        <span class="flavor-name">ë‹¨ë§›</span>
                        <div class="bar-container">
                            <div id="modal-sweetness-bar" class="bar-fill"></div>
                        </div>
                        <span id="modal-sweetness-score" class="flavor-score">0</span>
                    </div>
                </div>
            </div>
            
            <div class="recommendation-reason-section">
                <h4>ì¶”ì²œ ì´ìœ </h4>
                <p id="modal-reason" class="reason-text">-</p>
            </div>
            
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeWhiskeyModal()">
                    <i class="fas fa-arrow-left"></i> ëŒì•„ê°€ê¸°
                </button>
                <button id="modal-detail-btn" class="btn-primary" onclick="openWhiskeyDetailPage()">
                    <i class="fas fa-external-link-alt"></i> ìƒì„¸ í˜ì´ì§€ ë³´ê¸°
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* ì·¨í–¥ì •ë³´ í† ê¸€ ì„¹ì…˜ */
.preference-toggle-section {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
    transition: all 0.3s ease;
}

.preference-toggle-section:hover {
    border-color: #8b5a3c;
    background: #f7f5f3;
}

.toggle-wrapper {
    display: flex;
    gap: 15px;
    align-items: flex-start;
}

/* í† ê¸€ ìŠ¤ìœ„ì¹˜ */
.toggle-container {
    display: block;
    position: relative;
    cursor: pointer;
    flex-shrink: 0;
    margin-top: 5px;
}

.toggle-input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: relative;
    display: block;
    width: 60px;
    height: 32px;
    background-color: #ccc;
    border-radius: 16px;
    transition: all 0.3s ease;
}

.toggle-slider::before {
    content: '';
    position: absolute;
    height: 24px;
    width: 24px;
    left: 4px;
    top: 4px;
    background-color: white;
    border-radius: 50%;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.toggle-input:checked + .toggle-slider {
    background-color: #8b5a3c;
}

.toggle-input:checked + .toggle-slider::before {
    transform: translateX(28px);
}

/* í† ê¸€ ì •ë³´ */
.toggle-info {
    flex: 1;
}

.toggle-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1.1em;
    font-weight: 600;
    color: #374151;
    margin: 0 0 8px 0;
}

.toggle-title i {
    color: #8b5a3c;
}

.toggle-description {
    font-size: 0.9em;
    color: #6b7280;
    margin: 0 0 10px 0;
    line-height: 1.5;
}

/* ì·¨í–¥ì •ë³´ ìƒíƒœ */
.preference-status {
    font-size: 0.85em;
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 500;
    display: inline-block;
    transition: all 0.2s ease;
}

.preference-status.loaded {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #a7f3d0;
}

.preference-status.not-found {
    background: #fed7d7;
    color: #c53030;
    border: 1px solid #feb2b2;
}

.preference-status.loading {
    background: #e0f2fe;
    color: #0277bd;
    border: 1px solid #b3e5fc;
}

/* ë°˜ì‘í˜• ë””ìì¸ */
@media (max-width: 768px) {
    .toggle-wrapper {
        flex-direction: column;
        gap: 12px;
    }
    
    .toggle-container {
        align-self: flex-start;
        margin-top: 0;
    }
    
    .preference-toggle-section {
        padding: 15px;
        margin-bottom: 20px;
    }
}
</style>

<script>
class RecommendationManager {
    constructor() {
        this.userPreferences = null;
        this.isLoadingPreferences = false;
        this.init();
    }

    init() {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => this.setupElements());
        } else {
            this.setupElements();
        }
    }

    setupElements() {
        // í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸
        const toggleInput = document.getElementById('use-preferences');
        if (toggleInput) {
            toggleInput.addEventListener('change', () => this.handleToggleChange());
        }

        // ì¶”ì²œ ë²„íŠ¼ ì´ë²¤íŠ¸
        const recommendBtn = document.getElementById('recommend-btn');
        if (recommendBtn) {
            recommendBtn.addEventListener('click', () => this.handleRecommendation());
        }

        // ì´ˆê¸° ìƒíƒœ ì„¤ì •
        this.updatePreferenceStatus('í† ê¸€ì„ ì¼œë©´ ì·¨í–¥ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤', 'loading');
    }

    async handleToggleChange() {
        const toggleInput = document.getElementById('use-preferences');
        
        if (toggleInput.checked) {
            await this.loadUserPreferences();
        } else {
            this.userPreferences = null;
            this.updatePreferenceStatus('ì·¨í–¥ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤', '');
        }
    }

    async loadUserPreferences() {
        if (this.isLoadingPreferences) return;
        
        this.isLoadingPreferences = true;
        this.updatePreferenceStatus('ì·¨í–¥ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'loading');

        try {
            const response = await fetch('/api/preferences');
            const result = await response.json();
            
            if (result.success && result.preference) {
                this.userPreferences = result.preference;
                this.updatePreferenceStatus('ì·¨í–¥ì •ë³´ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤ âœ“', 'loaded');
            } else {
                this.userPreferences = null;
                this.updatePreferenceStatus('ì·¨í–¥ì •ë³´ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”', 'not-found');
                
                // í† ê¸€ ìë™ í•´ì œ
                const toggleInput = document.getElementById('use-preferences');
                if (toggleInput) {
                    toggleInput.checked = false;
                }
            }
        } catch (error) {
            console.error('ì·¨í–¥ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            this.userPreferences = null;
            this.updatePreferenceStatus('ì·¨í–¥ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'not-found');
            
            // í† ê¸€ ìë™ í•´ì œ
            const toggleInput = document.getElementById('use-preferences');
            if (toggleInput) {
                toggleInput.checked = false;
            }
        } finally {
            this.isLoadingPreferences = false;
        }
    }

    updatePreferenceStatus(message, type) {
        const statusElement = document.getElementById('preference-status');
        if (statusElement) {
            statusElement.textContent = message;
            statusElement.className = `preference-status ${type}`;
        }
    }

    async handleRecommendation() {
        const queryInput = document.getElementById('user-query');
        const toggleInput = document.getElementById('use-preferences');
        const recommendBtn = document.getElementById('recommend-btn');
        
        if (!queryInput || !recommendBtn) return;

        const query = queryInput.value.trim();
        if (!query) {
            alert('ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            queryInput.focus();
            return;
        }

        // ì·¨í–¥ì •ë³´ ì‚¬ìš© ì²´í¬
        if (toggleInput.checked && !this.userPreferences) {
            alert('ì·¨í–¥ì •ë³´ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.\nì·¨í–¥ ì„¤ì • í˜ì´ì§€ì—ì„œ ì •ë³´ë¥¼ ì…ë ¥í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            return;
        }

        const originalHTML = recommendBtn.innerHTML;
        
        try {
            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            recommendBtn.disabled = true;
            recommendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì¶”ì²œ ë°›ëŠ” ì¤‘...';

            // ìš”ì²­ ë°ì´í„° ì¤€ë¹„
            const requestData = {
                query: query,
                usePreferences: toggleInput.checked,
                preferences: toggleInput.checked ? this.userPreferences : null
            };

            // API í˜¸ì¶œ
            const response = await fetch('/api/recommend', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });

            const result = await response.json();
            
            if (result.success) {
                this.displayRecommendations(result);
            } else {
                alert('ì¶”ì²œ ì‹¤íŒ¨: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }

        } catch (error) {
            console.error('ì¶”ì²œ ìš”ì²­ ì‹¤íŒ¨:', error);
            alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        } finally {
            // ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
            recommendBtn.disabled = false;
            recommendBtn.innerHTML = originalHTML;
        }
    }

    displayRecommendations(result) {
        const container = document.getElementById('recommendations-container');
        const grid = document.getElementById('recommendations-grid');
        const countText = document.getElementById('recommendation-count-text');
        
        if (!container || !grid || !countText) return;

        // ì¶”ì²œ ê²°ê³¼ í‘œì‹œ
        if (result.recommendations && result.recommendations.length > 0) {
            countText.textContent = `${result.recommendations.length}ê°œì˜ ì¶”ì²œ ê²°ê³¼`;
            
            // ì¶”ì²œ ì¹´ë“œ ìƒì„±
            grid.innerHTML = result.recommendations.map(whiskey => 
                this.createWhiskeyCard(whiskey)
            ).join('');
            
            container.classList.remove('hidden');
            
            // ìŠ¤í¬ë¡¤ ì´ë™
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            alert('ì¡°ê±´ì— ë§ëŠ” ìœ„ìŠ¤í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    createWhiskeyCard(whiskey) {
        // ê¸°ì¡´ ì¹´ë“œ ìƒì„± ë¡œì§ì„ ì—¬ê¸°ì— êµ¬í˜„í•˜ê±°ë‚˜
        // ê¸°ì¡´ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë„ë¡ ìˆ˜ì •
        return `
            <div class="whiskey-card" onclick="openWhiskeyModal('${whiskey.whiskey_id}')">
                <div class="whiskey-image">
                    <div class="whiskey-icon">ğŸ¥ƒ</div>
                </div>
                <div class="whiskey-info">
                    <h4 class="whiskey-name">${whiskey.name}</h4>
                    <p class="whiskey-price">${whiskey.price ? whiskey.price.toLocaleString() + 'ì›' : 'ê°€ê²© ì •ë³´ ì—†ìŒ'}</p>
                    <div class="whiskey-tags">
                        ${whiskey.age ? `<span class="tag">${whiskey.age}ë…„ì‚°</span>` : ''}
                        ${whiskey.type ? `<span class="tag">${whiskey.type}</span>` : ''}
                    </div>
                    <p class="recommendation-reason">${whiskey.reason || 'ì¶”ì²œ ì´ìœ ê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'}</p>
                </div>
            </div>
        `;
    }
}

// ì „ì—­ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
if (!window.recommendationManager) {
    window.recommendationManager = new RecommendationManager();
}
</script>